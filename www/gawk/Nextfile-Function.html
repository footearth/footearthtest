<html lang="en">
<head>
<title>Nextfile Function - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="General-Functions.html#General-Functions" title="General Functions">
<link rel="next" href="Strtonum-Function.html#Strtonum-Function" title="Strtonum Function">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Nextfile-Function"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Strtonum-Function.html#Strtonum-Function">Strtonum Function</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="General-Functions.html#General-Functions">General Functions</a>
<hr>
</div>

<h4 class="subsection">12.2.1 Implementing <code>nextfile</code> as a Function</h4>

<p><a name="index-input-files_002c-skipping-1627"></a><!-- STARTOFRANGE libfnex -->
<a name="index-libraries-of-_0040command_007bawk_007d-functions_002c-_0040code_007bnextfile_007d-statement-1628"></a><!-- STARTOFRANGE flibnex -->
<a name="index-functions_002c-library_002c-_0040code_007bnextfile_007d-statement-1629"></a><!-- STARTOFRANGE nexim -->
<a name="index-g_t_0040code_007bnextfile_007d-statement_002c-implementing-1630"></a><a name="index-g_t_0040command_007bgawk_007d_002c-_0040code_007bnextfile_007d-statement-in-1631"></a>The <code>nextfile</code> statement, presented in
<a href="Nextfile-Statement.html#Nextfile-Statement">Nextfile Statement</a>,
is a <samp><span class="command">gawk</span></samp>-specific extension&mdash;it is not available in most other
implementations of <samp><span class="command">awk</span></samp>.  This section shows two versions of a
<code>nextfile</code> function that you can use to simulate <samp><span class="command">gawk</span></samp>'s
<code>nextfile</code> statement if you cannot use <samp><span class="command">gawk</span></samp>.

   <p>A first attempt at writing a <code>nextfile</code> function is as follows:

<pre class="example">     # nextfile --- skip remaining records in current file
     # this should be read in before the "main" awk program
     
     function nextfile()    { _abandon_ = FILENAME; next }
     _abandon_ == FILENAME  { next }
</pre>
   <p><a name="index-programming-conventions_002c-_0040code_007bnextfile_007d-statement-1632"></a>Because it supplies a rule that must be executed first, this file should
be included before the main program. This rule compares the current
data file's name (which is always in the <code>FILENAME</code> variable) to
a private variable named <code>_abandon_</code>.  If the file name matches,
then the action part of the rule executes a <code>next</code> statement to
go on to the next record.  (The use of &lsquo;<samp><span class="samp">_</span></samp>&rsquo; in the variable name is
a convention.  It is discussed more fully in
<a href="Library-Names.html#Library-Names">Library Names</a>.)

   <p>The use of the <code>next</code> statement effectively creates a loop that reads
all the records from the current data file. 
The end of the file is eventually reached and
a new data file is opened, changing the value of <code>FILENAME</code>. 
Once this happens, the comparison of <code>_abandon_</code> to <code>FILENAME</code>
fails, and execution continues with the first rule of the &ldquo;real&rdquo; program.

   <p>The <code>nextfile</code> function itself simply sets the value of <code>_abandon_</code>
and then executes a <code>next</code> statement to start the
loop.

   <p><a name="index-g_t_0040code_007bnextfile_007d-user_002ddefined-function-1633"></a>This initial version has a subtle problem. 
If the same data file is listed <em>twice</em> on the command line,
one right after the other
or even with just a variable assignment between them,
this code skips right through the file a second time, even though
it should stop when it gets to the end of the first occurrence. 
A second version of <code>nextfile</code> that remedies this problem
is shown here:

<pre class="example">     <!-- file eg/lib/nextfile.awk -->
     # nextfile --- skip remaining records in current file
     # correctly handle successive occurrences of the same file
     <!-- endfile -->
     <!-- file eg/lib/nextfile.awk -->
     # this should be read in before the "main" awk program
     
     function nextfile()   { _abandon_ = FILENAME; next }
     
     _abandon_ == FILENAME {
           if (FNR == 1)
               _abandon_ = ""
           else
               next
     }
     <!-- endfile -->
</pre>
   <p>The <code>nextfile</code> function has not changed.  It makes <code>_abandon_</code>
equal to the current file name and then executes a <code>next</code> statement. 
The <code>next</code> statement reads the next record and increments <code>FNR</code>
so that <code>FNR</code> is guaranteed to have a value of at least two. 
However, if <code>nextfile</code> is called for the last record in the file,
then <samp><span class="command">awk</span></samp> closes the current data file and moves on to the next
one.  Upon doing so, <code>FILENAME</code> is set to the name of the new file
and <code>FNR</code> is reset to one.  If this next file is the same as
the previous one, <code>_abandon_</code> is still equal to <code>FILENAME</code>. 
However, <code>FNR</code> is equal to one, telling us that this is a new
occurrence of the file and not the one we were reading when the
<code>nextfile</code> function was executed.  In that case, <code>_abandon_</code>
is reset to the empty string, so that further executions of this rule
fail (until the next time that <code>nextfile</code> is called).

   <p>If <code>FNR</code> is not one, then we are still in the original data file
and the program executes a <code>next</code> statement to skip through it.

   <p>An important question to ask at this point is: given that the
functionality of <code>nextfile</code> can be provided with a library file,
why is it built into <samp><span class="command">gawk</span></samp>?  Adding
features for little reason leads to larger, slower programs that are
harder to maintain. 
The answer is that building <code>nextfile</code> into <samp><span class="command">gawk</span></samp> provides
significant gains in efficiency.  If the <code>nextfile</code> function is executed
at the beginning of a large data file, <samp><span class="command">awk</span></samp> still has to scan the entire
file, splitting it up into records,
<!-- at least conceptually -->
just to skip over it.  The built-in
<code>nextfile</code> can simply close the file immediately and proceed to the
next one, which saves a lot of time.  This is particularly important in
<samp><span class="command">awk</span></samp>, because <samp><span class="command">awk</span></samp> programs are generally I/O-bound (i.e.,
they spend most of their time doing input and output, instead of performing
computations). 
<!-- ENDOFRANGE libfnex -->
<!-- ENDOFRANGE flibnex -->
<!-- ENDOFRANGE nexim -->

   </body></html>

