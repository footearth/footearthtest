<html lang="en">
<head>
<title>Two-way I/O - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Advanced-Features.html#Advanced-Features" title="Advanced Features">
<link rel="prev" href="Nondecimal-Data.html#Nondecimal-Data" title="Nondecimal Data">
<link rel="next" href="TCP_002fIP-Networking.html#TCP_002fIP-Networking" title="TCP/IP Networking">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Two-way-I%2fO"></a>
<a name="Two_002dway-I_002fO"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="TCP_002fIP-Networking.html#TCP_002fIP-Networking">TCP/IP Networking</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Nondecimal-Data.html#Nondecimal-Data">Nondecimal Data</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Advanced-Features.html#Advanced-Features">Advanced Features</a>
<hr>
</div>

<h3 class="section">10.2 Two-Way Communications with Another Process</h3>

<p><a name="index-Brennan_002c-Michael-1410"></a><a name="index-programmers_002c-attractiveness-of-1411"></a>
<pre class="smallexample">     <!-- Path: cssun.mathcs.emory.edu!gatech!newsxfer3.itd.umich.edu!news-peer.sprintlink.net!news-sea-19.sprintlink.net!news-in-west.sprintlink.net!news.sprintlink.net!Sprint!204.94.52.5!news.whidbey.com!brennan -->
     From: brennan@whidbey.com (Mike Brennan)
     Newsgroups: comp.lang.awk
     Subject: Re: Learn the SECRET to Attract Women Easily
     Date: 4 Aug 1997 17:34:46 GMT
     <!-- Organization: WhidbeyNet -->
     <!-- Lines: 12 -->
     Message-ID: &lt;5s53rm$eca@news.whidbey.com&gt;
     <!-- References: <5s20dn$2e1@chronicle.concentric.net> -->
     <!-- Reply-To: brennan@whidbey.com -->
     <!-- NNTP-Posting-Host: asn202.whidbey.com -->
     <!-- X-Newsreader: slrn (0.9.4.1 UNIX) -->
     <!-- Xref: cssun.mathcs.emory.edu comp.lang.awk:5403 -->
     
     On 3 Aug 1997 13:17:43 GMT, Want More Dates???
     &lt;tracy78@kilgrona.com&gt; wrote:
     &gt;Learn the SECRET to Attract Women Easily
     &gt;
     &gt;The SCENT(tm)  Pheromone Sex Attractant For Men to Attract Women
     
     The scent of awk programmers is a lot more attractive to women than
     the scent of perl programmers.
     --
     Mike Brennan
     <!-- brennan@@whidbey.com -->
</pre>
   <p><a name="index-advanced-features_002c-_0040command_007bgawk_007d_002c-processes_0040comma_007b_007d-communicating-with-1412"></a><a name="index-processes_002c-two_002dway-communications-with-1413"></a>It is often useful to be able to
send data to a separate program for
processing and then read the result.  This can always be
done with temporary files:

<pre class="example">     # write the data for processing
     tempfile = ("mydata." PROCINFO["pid"])
     while (<var>not done with data</var>)
         print <var>data</var> | ("subprogram &gt; " tempfile)
     close("subprogram &gt; " tempfile)
     
     # read the results, remove tempfile when done
     while ((getline newdata &lt; tempfile) &gt; 0)
         <var>process</var> newdata <var>appropriately</var>
     close(tempfile)
     system("rm " tempfile)
</pre>
   <p class="noindent">This works, but not elegantly.  Among other things, it requires that
the program be run in a directory that cannot be shared among users;
for example, <samp><span class="file">/tmp</span></samp> will not do, as another user might happen
to be using a temporary file with the same name.

   <p><a name="index-coprocesses-1414"></a><a name="index-input_002foutput_002c-two_002dway-1415"></a><a name="index-g_t_0040code_007b_007c_007d-_0028vertical-bar_0029_002c-_0040code_007b_007c_0026_007d-operator-_0028I_002fO_0029-1416"></a><a name="index-vertical-bar-_0028_0040code_007b_007c_007d_0029_002c-_0040code_007b_007c_0026_007d-I_002fO-operator-_0028I_002fO_0029-1417"></a><a name="index-g_t_0040command_007bcsh_007d-utility_002c-_0040code_007b_007c_0026_007d-operator_002c-comparison-with-1418"></a>Starting with version 3.1 of <samp><span class="command">gawk</span></samp>, it is possible to
open a <em>two-way</em> pipe to another process.  The second process is
termed a <dfn>coprocess</dfn>, since it runs in parallel with <samp><span class="command">gawk</span></samp>. 
The two-way connection is created using the new &lsquo;<samp><span class="samp">|&amp;</span></samp>&rsquo; operator
(borrowed from the Korn shell, <samp><span class="command">ksh</span></samp>):<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>

<pre class="example">     do {
         print <var>data</var> |&amp; "subprogram"
         "subprogram" |&amp; getline results
     } while (<var>data left to process</var>)
     close("subprogram")
</pre>
   <p>The first time an I/O operation is executed using the &lsquo;<samp><span class="samp">|&amp;</span></samp>&rsquo;
operator, <samp><span class="command">gawk</span></samp> creates a two-way pipeline to a child process
that runs the other program.  Output created with <code>print</code>
or <code>printf</code> is written to the program's standard input, and
output from the program's standard output can be read by the <samp><span class="command">gawk</span></samp>
program using <code>getline</code>. 
As is the case with processes started by &lsquo;<samp><span class="samp">|</span></samp>&rsquo;, the subprogram
can be any program, or pipeline of programs, that can be started by
the shell.

   <p>There are some cautionary items to be aware of:

     <ul>
<li>As the code inside <samp><span class="command">gawk</span></samp> currently stands, the coprocess's
standard error goes to the same place that the parent <samp><span class="command">gawk</span></samp>'s
standard error goes. It is not possible to read the child's
standard error separately.

     <p><a name="index-deadlocks-1419"></a><a name="index-buffering_002c-input_002foutput-1420"></a><a name="index-g_t_0040code_007bgetline_007d-command_002c-deadlock-and-1421"></a><li>I/O buffering may be a problem.  <samp><span class="command">gawk</span></samp> automatically
flushes all output down the pipe to the child process. 
However, if the coprocess does not flush its output,
<samp><span class="command">gawk</span></samp> may hang when doing a <code>getline</code> in order to read
the coprocess's results.  This could lead to a situation
known as <dfn>deadlock</dfn>, where each process is waiting for the
other one to do something. 
</ul>

   <p><a name="index-g_t_0040code_007bclose_007d-function_002c-two_002dway-pipes-and-1422"></a>It is possible to close just one end of the two-way pipe to
a coprocess, by supplying a second argument to the <code>close</code>
function of either <code>"to"</code> or <code>"from"</code>
(see <a href="Close-Files-And-Pipes.html#Close-Files-And-Pipes">Close Files And Pipes</a>). 
These strings tell <samp><span class="command">gawk</span></samp> to close the end of the pipe
that sends data to the process or the end that reads from it,
respectively.

   <p><a name="index-g_t_0040command_007bsort_007d-utility_002c-coprocesses-and-1423"></a>This is particularly necessary in order to use
the system <samp><span class="command">sort</span></samp> utility as part of a coprocess;
<samp><span class="command">sort</span></samp> must read <em>all</em> of its input
data before it can produce any output. 
The <samp><span class="command">sort</span></samp> program does not receive an end-of-file indication
until <samp><span class="command">gawk</span></samp> closes the write end of the pipe.

   <p>When you have finished writing data to the <samp><span class="command">sort</span></samp>
utility, you can close the <code>"to"</code> end of the pipe, and
then start reading sorted data via <code>getline</code>. 
For example:

<pre class="example">     BEGIN {
         command = "LC_ALL=C sort"
         n = split("abcdefghijklmnopqrstuvwxyz", a, "")
     
         for (i = n; i &gt; 0; i--)
             print a[i] |&amp; command
         close(command, "to")
     
         while ((command |&amp; getline line) &gt; 0)
             print "got", line
         close(command)
     }
</pre>
   <p>This program writes the letters of the alphabet in reverse order, one
per line, down the two-way pipe to <samp><span class="command">sort</span></samp>.  It then closes the
write end of the pipe, so that <samp><span class="command">sort</span></samp> receives an end-of-file
indication.  This causes <samp><span class="command">sort</span></samp> to sort the data and write the
sorted data back to the <samp><span class="command">gawk</span></samp> program.  Once all of the data
has been read, <samp><span class="command">gawk</span></samp> terminates the coprocess and exits.

   <p>As a side note, the assignment &lsquo;<samp><span class="samp">LC_ALL=C</span></samp>&rsquo; in the <samp><span class="command">sort</span></samp>
command ensures traditional Unix (ASCII) sorting from <samp><span class="command">sort</span></samp>.

   <p>Beginning with <samp><span class="command">gawk</span></samp> 3.1.2, you may use Pseudo-ttys (ptys) for
two-way communication instead of pipes, if your system supports them. 
This is done on a per-command basis, by setting a special element
in the <code>PROCINFO</code> array
(see <a href="Auto_002dset.html#Auto_002dset">Auto-set</a>),
like so:

<pre class="example">     command = "sort -nr"           # command, saved in variable for convenience
     PROCINFO[command, "pty"] = 1   # update PROCINFO
     print ... |&amp; command       # start two-way pipe
     ...
</pre>
   <p class="noindent">Using ptys avoids the buffer deadlock issues described earlier, at some
loss in performance.  If your system does not have ptys, or if all the
system's ptys are in use, <samp><span class="command">gawk</span></samp> automatically falls back to
using regular pipes.

   <div class="footnote">
<hr>
<h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> This is very
different from the same operator in the C shell, <samp><span class="command">csh</span></samp>.</p>

   <hr></div>

   </body></html>

