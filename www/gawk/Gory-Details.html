<html lang="en">
<head>
<title>Gory Details - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="String-Functions.html#String-Functions" title="String Functions">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Gory-Details"></a>
<p>
Up:&nbsp;<a rel="up" accesskey="u" href="String-Functions.html#String-Functions">String Functions</a>
<hr>
</div>

<h5 class="subsubsection">8.1.3.1 More About &lsquo;<samp><span class="samp">\</span></samp>&rsquo; and &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo; with <code>sub</code>, <code>gsub</code>, and <code>gensub</code></h5>

<p><a name="index-escape-processing_002c-_0040code_007bgsub_007d_002f_0040code_007bgensub_007d_002f_0040code_007bsub_007d-functions-1204"></a><a name="index-g_t_0040code_007bsub_007d-function_002c-escape-processing-1205"></a><a name="index-g_t_0040code_007bgsub_007d-function_002c-escape-processing-1206"></a><a name="index-g_t_0040code_007bgensub_007d-function-_0028_0040command_007bgawk_007d_0029_002c-escape-processing-1207"></a><a name="index-g_t_0040code_007b_005c_007d-_0028backslash_0029_002c-_0040code_007bgsub_007d_002f_0040code_007bgensub_007d_002f_0040code_007bsub_007d-functions-and-1208"></a><a name="index-backslash-_0028_0040code_007b_005c_007d_0029_002c-_0040code_007bgsub_007d_002f_0040code_007bgensub_007d_002f_0040code_007bsub_007d-functions-and-1209"></a><a name="index-g_t_0040code_007b_0026_007d-_0028ampersand_0029_002c-_0040code_007bgsub_007d_002f_0040code_007bgensub_007d_002f_0040code_007bsub_007d-functions-and-1210"></a><a name="index-ampersand-_0028_0040code_007b_0026_007d_0029_002c-_0040code_007bgsub_007d_002f_0040code_007bgensub_007d_002f_0040code_007bsub_007d-functions-and-1211"></a>When using <code>sub</code>, <code>gsub</code>, or <code>gensub</code>, and trying to get literal
backslashes and ampersands into the replacement text, you need to remember
that there are several levels of <dfn>escape processing</dfn> going on.

   <p>First, there is the <dfn>lexical</dfn> level, which is when <samp><span class="command">awk</span></samp> reads
your program
and builds an internal copy of it that can be executed. 
Then there is the runtime level, which is when <samp><span class="command">awk</span></samp> actually scans the
replacement string to determine what to generate.

   <p>At both levels, <samp><span class="command">awk</span></samp> looks for a defined set of characters that
can come after a backslash.  At the lexical level, it looks for the
escape sequences listed in <a href="Escape-Sequences.html#Escape-Sequences">Escape Sequences</a>. 
Thus, for every &lsquo;<samp><span class="samp">\</span></samp>&rsquo; that <samp><span class="command">awk</span></samp> processes at the runtime
level, type two backslashes at the lexical level. 
When a character that is not valid for an escape sequence follows the
&lsquo;<samp><span class="samp">\</span></samp>&rsquo;, Unix <samp><span class="command">awk</span></samp> and <samp><span class="command">gawk</span></samp> both simply remove the initial
&lsquo;<samp><span class="samp">\</span></samp>&rsquo; and put the next character into the string. Thus, for
example, <code>"a\qb"</code> is treated as <code>"aqb"</code>.

   <p>At the runtime level, the various functions handle sequences of
&lsquo;<samp><span class="samp">\</span></samp>&rsquo; and &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo; differently.  The situation is (sadly) somewhat complex. 
Historically, the <code>sub</code> and <code>gsub</code> functions treated the two
character sequence &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo; specially; this sequence was replaced in
the generated text with a single &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;.  Any other &lsquo;<samp><span class="samp">\</span></samp>&rsquo; within
the <var>replacement</var> string that did not precede an &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo; was passed
through unchanged.  This is illustrated in <a href="table_002dsub_002descapes.html#table_002dsub_002descapes">table-sub-escapes</a>.

<!-- Thank to Karl Berry for help with the TeX stuff. -->
   <div class="float">
<a name="table_002dsub_002descapes"></a>
<pre class="display">      You type         <code>sub</code> sees          <code>sub</code> generates
      &mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&ndash;          &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
          <code>\&amp;</code>              <code>&amp;</code>            the matched text
         <code>\\&amp;</code>             <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
        <code>\\\&amp;</code>             <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
       <code>\\\\&amp;</code>            <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
      <code>\\\\\&amp;</code>            <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
     <code>\\\\\\&amp;</code>           <code>\\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\\&amp;</span></samp>&rsquo;
         <code>\\q</code>             <code>\q</code>            a literal &lsquo;<samp><span class="samp">\q</span></samp>&rsquo;
</pre>
   <p><strong class="float-caption">Table 8.1: Historical Escape Sequence Processing for sub and gsub</strong></p></div>

<p class="noindent">This table shows both the lexical-level processing, where
an odd number of backslashes becomes an even number at the runtime level,
as well as the runtime processing done by <code>sub</code>. 
(For the sake of simplicity, the rest of the following tables only show the
case of even numbers of backslashes entered at the lexical level.)

   <p>The problem with the historical approach is that there is no way to get
a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo; followed by the matched text.

<!-- @cindex @command{awk} language, POSIX version -->
   <p><a name="index-POSIX-_0040command_007bawk_007d_002c-functions-and_002c-_0040code_007bgsub_007d_002f_0040code_007bsub_007d-1212"></a>The 1992 POSIX standard attempted to fix this problem. That standard
says that <code>sub</code> and <code>gsub</code> look for either a &lsquo;<samp><span class="samp">\</span></samp>&rsquo; or an &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
after the &lsquo;<samp><span class="samp">\</span></samp>&rsquo;. If either one follows a &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, that character is
output literally.  The interpretation of &lsquo;<samp><span class="samp">\</span></samp>&rsquo; and &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo; then becomes
as shown in <a href="table_002dsub_002dposix_002d92.html#table_002dsub_002dposix_002d92">table-sub-posix-92</a>.

   <div class="float">
<a name="table_002dsub_002dposix_002d92"></a>
<!-- thanks to Karl Berry for formatting this table -->
<pre class="display">      You type         <code>sub</code> sees          <code>sub</code> generates
      &mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&ndash;          &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
           <code>&amp;</code>              <code>&amp;</code>            the matched text
         <code>\\&amp;</code>             <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
       <code>\\\\&amp;</code>            <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, then the matched text
     <code>\\\\\\&amp;</code>           <code>\\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
</pre>
   <p><strong class="float-caption">Table 8.2: 1992 POSIX Rules for sub and gsub Escape Sequence Processing</strong></p></div>

<p class="noindent">This appears to solve the problem. 
Unfortunately, the phrasing of the standard is unusual. It
says, in effect, that &lsquo;<samp><span class="samp">\</span></samp>&rsquo; turns off the special meaning of any
following character, but for anything other than &lsquo;<samp><span class="samp">\</span></samp>&rsquo; and &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;,
such special meaning is undefined.  This wording leads to two problems:

     <ul>
<li>Backslashes must now be doubled in the <var>replacement</var> string, breaking
historical <samp><span class="command">awk</span></samp> programs.

     <li>To make sure that an <samp><span class="command">awk</span></samp> program is portable, <em>every</em> character
in the <var>replacement</var> string must be preceded with a
backslash.<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>
<!-- I can say that, 'cause I was involved in making this change -->
</ul>

   <p>Because of the problems just listed,
in 1996, the <samp><span class="command">gawk</span></samp> maintainer submitted
proposed text for a revised standard that
reverts to rules that correspond more closely to the original existing
practice. The proposed rules have special cases that make it possible
to produce a &lsquo;<samp><span class="samp">\</span></samp>&rsquo; preceding the matched text. This is shown in
<a href="table_002dsub_002dproposed.html#table_002dsub_002dproposed">table-sub-proposed</a>.

   <div class="float">
<a name="table_002dsub_002dproposed"></a>
<pre class="display">      You type         <code>sub</code> sees         <code>sub</code> generates
      &mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
     <code>\\\\\\&amp;</code>           <code>\\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
       <code>\\\\&amp;</code>            <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, followed by the matched text
         <code>\\&amp;</code>             <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
         <code>\\q</code>             <code>\q</code>            a literal &lsquo;<samp><span class="samp">\q</span></samp>&rsquo;
        <code>\\\\</code>             <code>\\</code>            <code>\\</code>
</pre>
   <p><strong class="float-caption">Table 8.3: Proposed rules for sub and backslash</strong></p></div>

   <p>In a nutshell, at the runtime level, there are now three special sequences
of characters (&lsquo;<samp><span class="samp">\\\&amp;</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\\&amp;</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;) whereas historically
there was only one.  However, as in the historical case, any &lsquo;<samp><span class="samp">\</span></samp>&rsquo; that
is not part of one of these three sequences is not special and appears
in the output literally.

   <p><samp><span class="command">gawk</span></samp> 3.0 and 3.1 follow these proposed POSIX rules for <code>sub</code> and
<code>gsub</code>. 
<!-- As much as we think it's a lousy idea. You win some, you lose some. Sigh. -->
The POSIX standard took much longer to be revised than was expected in 1996. 
The 2001 standard does not follow the above rules.  Instead, the rules
there are somewhat simpler.  The results are similar except for one case.

   <p>The 2001 POSIX rules state that &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo; in the replacement string produces
a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\\</span></samp>&rsquo; produces a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\</span></samp>&rsquo; followed
by anything else is not special; the &lsquo;<samp><span class="samp">\</span></samp>&rsquo; is placed straight into the output. 
These rules are presented in <a href="table_002dposix_002d2001_002dsub.html#table_002dposix_002d2001_002dsub">table-posix-2001-sub</a>.

   <div class="float">
<a name="table_002dposix_002d2001_002dsub"></a>
<pre class="display">      You type         <code>sub</code> sees         <code>sub</code> generates
      &mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&ndash;         &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
     <code>\\\\\\&amp;</code>           <code>\\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
       <code>\\\\&amp;</code>            <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, followed by the matched text
         <code>\\&amp;</code>             <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
         <code>\\q</code>             <code>\q</code>            a literal &lsquo;<samp><span class="samp">\q</span></samp>&rsquo;
        <code>\\\\</code>             <code>\\</code>            <code>\</code>
</pre>
   <p><strong class="float-caption">Table 8.4: POSIX 2001 rules for sub</strong></p></div>

   <p>The only case where the difference is noticeable is the last one: &lsquo;<samp><span class="samp">\\\\</span></samp>&rsquo;
is seen as &lsquo;<samp><span class="samp">\\</span></samp>&rsquo; and produces &lsquo;<samp><span class="samp">\</span></samp>&rsquo; instead of &lsquo;<samp><span class="samp">\\</span></samp>&rsquo;.

   <p>Starting with version 3.1.4, <samp><span class="command">gawk</span></samp> follows the POSIX rules
when <samp><span class="option">--posix</span></samp> is specified (see <a href="Options.html#Options">Options</a>). Otherwise,
it continues to follow the 1996 proposed rules, since, as of this
writing, that has been its behavior for over seven years.

   <blockquote>
<b>NOTE:</b> At the next major release, <samp><span class="command">gawk</span></samp> will switch to using
the POSIX 2001 rules by default. 
</blockquote>

   <p>The rules for <code>gensub</code> are considerably simpler. At the runtime
level, whenever <samp><span class="command">gawk</span></samp> sees a &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, if the following character
is a digit, then the text that matched the corresponding parenthesized
subexpression is placed in the generated output.  Otherwise,
no matter what character follows the &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, it
appears in the generated text and the &lsquo;<samp><span class="samp">\</span></samp>&rsquo; does not,
as shown in <a href="table_002dgensub_002descapes.html#table_002dgensub_002descapes">table-gensub-escapes</a>.

   <div class="float">
<a name="table_002dgensub_002descapes"></a>
<pre class="display">       You type          <code>gensub</code> sees         <code>gensub</code> generates
       &mdash;&mdash;&mdash;&ndash;          &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;         &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
           <code>&amp;</code>                    <code>&amp;</code>            the matched text
         <code>\\&amp;</code>                   <code>\&amp;</code>            a literal &lsquo;<samp><span class="samp">&amp;</span></samp>&rsquo;
        <code>\\\\</code>                   <code>\\</code>            a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;
       <code>\\\\&amp;</code>                  <code>\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\</span></samp>&rsquo;, then the matched text
     <code>\\\\\\&amp;</code>                 <code>\\\&amp;</code>            a literal &lsquo;<samp><span class="samp">\&amp;</span></samp>&rsquo;
         <code>\\q</code>                   <code>\q</code>            a literal &lsquo;<samp><span class="samp">q</span></samp>&rsquo;
</pre>
   <p><strong class="float-caption">Table 8.5: Escape Sequence Processing for gensub</strong></p></div>

   <p>Because of the complexity of the lexical and runtime level processing
and the special cases for <code>sub</code> and <code>gsub</code>,
we recommend the use of <samp><span class="command">gawk</span></samp> and <code>gensub</code> when you have
to do substitutions.

<!-- fakenode - for prepinfo -->
<h4 class="subheading">Advanced Notes: Matching the Null String</h4>

<p><a name="index-advanced-features_002c-null-strings_0040comma_007b_007d-matching-1213"></a><a name="index-matching_002c-null-strings-1214"></a><a name="index-null-strings_002c-matching-1215"></a><a name="index-g_t_0040code_007b_002a_007d-_0028asterisk_0029_002c-_0040code_007b_002a_007d-operator_002c-null-strings_0040comma_007b_007d-matching-1216"></a><a name="index-asterisk-_0028_0040code_007b_002a_007d_0029_002c-_0040code_007b_002a_007d-operator_002c-null-strings_0040comma_007b_007d-matching-1217"></a>
In <samp><span class="command">awk</span></samp>, the &lsquo;<samp><span class="samp">*</span></samp>&rsquo; operator can match the null string. 
This is particularly important for the <code>sub</code>, <code>gsub</code>,
and <code>gensub</code> functions.  For example:

<pre class="example">     $ echo abc | awk '{ gsub(/m*/, "X"); print }'
     -| XaXbXcX
</pre>
   <p class="noindent">Although this makes a certain amount of sense, it can be surprising.

   <div class="footnote">
<hr>
<h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> This consequence was certainly unintended.</p>

   <hr></div>

   </body></html>

