<html lang="en">
<head>
<title>Passwd Functions - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Library-Functions.html#Library-Functions" title="Library Functions">
<link rel="prev" href="Getopt-Function.html#Getopt-Function" title="Getopt Function">
<link rel="next" href="Group-Functions.html#Group-Functions" title="Group Functions">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Passwd-Functions"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Group-Functions.html#Group-Functions">Group Functions</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Getopt-Function.html#Getopt-Function">Getopt Function</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Library-Functions.html#Library-Functions">Library Functions</a>
<hr>
</div>

<h3 class="section">12.5 Reading the User Database</h3>

<!-- STARTOFRANGE libfudata -->
<p><a name="index-libraries-of-_0040command_007bawk_007d-functions_002c-user-database_002c-reading-1704"></a><!-- STARTOFRANGE flibudata -->
<a name="index-functions_002c-library_002c-user-database_002c-reading-1705"></a><!-- STARTOFRANGE udatar -->
<a name="index-user-database_0040comma_007b_007d-reading-1706"></a><!-- STARTOFRANGE dataur -->
<a name="index-database_002c-users_0040comma_007b_007d-reading-1707"></a><a name="index-g_t_0040code_007bPROCINFO_007d-array-1708"></a>The <code>PROCINFO</code> array
(see <a href="Built_002din-Variables.html#Built_002din-Variables">Built-in Variables</a>)
provides access to the current user's real and effective user and group ID
numbers, and if available, the user's supplementary group set. 
However, because these are numbers, they do not provide very useful
information to the average user.  There needs to be some way to find the
user information associated with the user and group ID numbers.  This
section presents a suite of functions for retrieving information from the
user database.  See <a href="Group-Functions.html#Group-Functions">Group Functions</a>,
for a similar suite that retrieves information from the group database.

   <p><a name="index-g_t_0040code_007bgetpwent_007d-function-_0028C-library_0029-1709"></a><a name="index-g_t_0040code_007bgetpwent_007d-user_002ddefined-function-1710"></a><a name="index-users_002c-information-about_002c-retrieving-1711"></a><a name="index-login-information-1712"></a><a name="index-account-information-1713"></a><a name="index-password-file-1714"></a><a name="index-files_002c-password-1715"></a>The POSIX standard does not define the file where user information is
kept.  Instead, it provides the <code>&lt;pwd.h&gt;</code> header file
and several C language subroutines for obtaining user information. 
The primary function is <code>getpwent</code>, for &ldquo;get password entry.&rdquo;
The &ldquo;password&rdquo; comes from the original user database file,
<samp><span class="file">/etc/passwd</span></samp>, which stores user information, along with the
encrypted passwords (hence the name).

   <p><a name="index-g_t_0040command_007bpwcat_007d-program-1716"></a>While an <samp><span class="command">awk</span></samp> program could simply read <samp><span class="file">/etc/passwd</span></samp>
directly, this file may not contain complete information about the
system's set of users.<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a> To be sure you are able to
produce a readable and complete version of the user database, it is necessary
to write a small C program that calls <code>getpwent</code>.  <code>getpwent</code>
is defined as returning a pointer to a <code>struct passwd</code>.  Each time it
is called, it returns the next entry in the database.  When there are
no more entries, it returns <code>NULL</code>, the null pointer.  When this
happens, the C program should call <code>endpwent</code> to close the database. 
Following is <samp><span class="command">pwcat</span></samp>, a C program that &ldquo;cats&rdquo; the password database:

<!-- Use old style function header for portability to old systems (SunOS, HP/UX). -->
<pre class="example">     <!-- file eg/lib/pwcat.c -->
     /*
      * pwcat.c
      *
      * Generate a printable version of the password database
      */
     <!-- endfile -->
     <!-- file eg/lib/pwcat.c -->
     #include &lt;stdio.h&gt;
     #include &lt;pwd.h&gt;
     
     <!-- endfile -->
     <!-- file eg/lib/pwcat.c -->
     int
     main(argc, argv)
     int argc;
     char **argv;
     {
         struct passwd *p;
     
         while ((p = getpwent()) != NULL)
     <!-- endfile -->
     <!-- file eg/lib/pwcat.c -->
             printf("%s:%s:%ld:%ld:%s:%s:%s\n",
                 p-&gt;pw_name, p-&gt;pw_passwd, (long) p-&gt;pw_uid,
                 (long) p-&gt;pw_gid, p-&gt;pw_gecos, p-&gt;pw_dir, p-&gt;pw_shell);
     <!-- endfile -->
     <!-- file eg/lib/pwcat.c -->
     
         endpwent();
         return 0;
     }
     <!-- endfile -->
</pre>
   <p>If you don't understand C, don't worry about it. 
The output from <samp><span class="command">pwcat</span></samp> is the user database, in the traditional
<samp><span class="file">/etc/passwd</span></samp> format of colon-separated fields.  The fields are:

   <p><table summary=""><tr align="left"><td valign="top">Login name </td><td valign="top">The user's login name.

<p><br></td></tr><tr align="left"><td valign="top">Encrypted password </td><td valign="top">The user's encrypted password.  This may not be available on some systems.

<p><br></td></tr><tr align="left"><td valign="top">User-ID </td><td valign="top">The user's numeric user ID number.

<p><br></td></tr><tr align="left"><td valign="top">Group-ID </td><td valign="top">The user's numeric group ID number.

<p><br></td></tr><tr align="left"><td valign="top">Full name </td><td valign="top">The user's full name, and perhaps other information associated with the
user.

<p><br></td></tr><tr align="left"><td valign="top">Home directory </td><td valign="top">The user's login (or &ldquo;home&rdquo;) directory (familiar to shell programmers as
<code>$HOME</code>).

<p><br></td></tr><tr align="left"><td valign="top">Login shell </td><td valign="top">The program that is run when the user logs in.  This is usually a
shell, such as <samp><span class="command">bash</span></samp>.
   <br></td></tr></table>

   <p>A few lines representative of <samp><span class="command">pwcat</span></samp>'s output are as follows:

   <p><a name="index-Jacobs_002c-Andrew-1717"></a><a name="index-Robbins_002c-Arnold-1718"></a><a name="index-Robbins_002c-Miriam-1719"></a>
<pre class="example">     $ pwcat
     -| root:3Ov02d5VaUPB6:0:1:Operator:/:/bin/sh
     -| nobody:*:65534:65534::/:
     -| daemon:*:1:1::/:
     -| sys:*:2:2::/:/bin/csh
     -| bin:*:3:3::/bin:
     -| arnold:xyzzy:2076:10:Arnold Robbins:/home/arnold:/bin/sh
     -| miriam:yxaay:112:10:Miriam Robbins:/home/miriam:/bin/sh
     -| andy:abcca2:113:10:Andy Jacobs:/home/andy:/bin/sh
     ...
</pre>
   <p>With that introduction, following is a group of functions for getting user
information.  There are several functions here, corresponding to the C
functions of the same names:

<!-- Exercise: simplify all these functions that return values. -->
<!-- Answer: return foo[key] returns "" if key not there, no need to check with `in'. -->
   <p><a name="index-g_t_0040code_007b_005fpw_005finit_007d-user_002ddefined-function-1720"></a>
<pre class="example">     <!-- file eg/lib/passwdawk.in -->
     # passwd.awk --- access password file information
     <!-- endfile -->
     <!-- file eg/lib/passwdawk.in -->
     BEGIN {
         # tailor this to suit your system
         _pw_awklib = "/usr/local/libexec/awk/"
     }
     
     function _pw_init(    oldfs, oldrs, olddol0, pwcat, using_fw)
     {
         if (_pw_inited)
             return
     
         oldfs = FS
         oldrs = RS
         olddol0 = $0
         using_fw = (PROCINFO["FS"] == "FIELDWIDTHS")
         FS = ":"
         RS = "\n"
     
         pwcat = _pw_awklib "pwcat"
         while ((pwcat | getline) &gt; 0) {
             _pw_byname[$1] = $0
             _pw_byuid[$3] = $0
             _pw_bycount[++_pw_total] = $0
         }
         close(pwcat)
         _pw_count = 0
         _pw_inited = 1
         FS = oldfs
         if (using_fw)
             FIELDWIDTHS = FIELDWIDTHS
         RS = oldrs
         $0 = olddol0
     }
     <!-- endfile -->
</pre>
   <p><a name="index-g_t_0040code_007bBEGIN_007d-pattern_002c-_0040code_007bpwcat_007d-program-1721"></a>The <code>BEGIN</code> rule sets a private variable to the directory where
<samp><span class="command">pwcat</span></samp> is stored.  Because it is used to help out an <samp><span class="command">awk</span></samp> library
routine, we have chosen to put it in <samp><span class="file">/usr/local/libexec/awk</span></samp>;
however, you might want it to be in a different directory on your system.

   <p>The function <code>_pw_init</code> keeps three copies of the user information
in three associative arrays.  The arrays are indexed by username
(<code>_pw_byname</code>), by user ID number (<code>_pw_byuid</code>), and by order of
occurrence (<code>_pw_bycount</code>). 
The variable <code>_pw_inited</code> is used for efficiency; <code>_pw_init</code>
needs only to be called once.

   <p><a name="index-g_t_0040code_007bgetline_007d-command_002c-_0040code_007b_005fpw_005finit_007d-function-1722"></a>Because this function uses <code>getline</code> to read information from
<samp><span class="command">pwcat</span></samp>, it first saves the values of <code>FS</code>, <code>RS</code>, and <code>$0</code>. 
It notes in the variable <code>using_fw</code> whether field splitting
with <code>FIELDWIDTHS</code> is in effect or not. 
Doing so is necessary, since these functions could be called
from anywhere within a user's program, and the user may have his
or her
own way of splitting records and fields.

   <p>The <code>using_fw</code> variable checks <code>PROCINFO["FS"]</code>, which
is <code>"FIELDWIDTHS"</code> if field splitting is being done with
<code>FIELDWIDTHS</code>.  This makes it possible to restore the correct
field-splitting mechanism later.  The test can only be true for
<samp><span class="command">gawk</span></samp>.  It is false if using <code>FS</code> or on some other
<samp><span class="command">awk</span></samp> implementation.

   <p>The main part of the function uses a loop to read database lines, split
the line into fields, and then store the line into each array as necessary. 
When the loop is done, <code>_pw_init<!-- /@w --></code> cleans up by closing the pipeline,
setting <code>_pw_inited<!-- /@w --></code> to one, and restoring <code>FS</code> (and <code>FIELDWIDTHS</code>
if necessary), <code>RS</code>, and <code>$0</code>. 
The use of <code>_pw_count<!-- /@w --></code> is explained shortly.

<!-- NEXT ED: All of these functions don't need the ... in ... test.  Just -->
<!-- return the array element, which will be "" if not already there.  Duh. -->
   <p><a name="index-g_t_0040code_007bgetpwnam_007d-function-_0028C-library_0029-1723"></a>The <code>getpwnam</code> function takes a username as a string argument. If that
user is in the database, it returns the appropriate line. Otherwise, it
returns the null string:

   <p><a name="index-g_t_0040code_007bgetpwnam_007d-user_002ddefined-function-1724"></a>
<pre class="example">     <!-- file eg/lib/passwdawk.in -->
     function getpwnam(name)
     {
         _pw_init()
         if (name in _pw_byname)
             return _pw_byname[name]
         return ""
     }
     <!-- endfile -->
</pre>
   <p><a name="index-g_t_0040code_007bgetpwuid_007d-function-_0028C-library_0029-1725"></a>Similarly,
the <code>getpwuid</code> function takes a user ID number argument. If that
user number is in the database, it returns the appropriate line. Otherwise, it
returns the null string:

   <p><a name="index-g_t_0040code_007bgetpwuid_007d-user_002ddefined-function-1726"></a>
<pre class="example">     <!-- file eg/lib/passwdawk.in -->
     function getpwuid(uid)
     {
         _pw_init()
         if (uid in _pw_byuid)
             return _pw_byuid[uid]
         return ""
     }
     <!-- endfile -->
</pre>
   <p><a name="index-g_t_0040code_007bgetpwent_007d-function-_0028C-library_0029-1727"></a>The <code>getpwent</code> function simply steps through the database, one entry at
a time.  It uses <code>_pw_count</code> to track its current position in the
<code>_pw_bycount</code> array:

   <p><a name="index-g_t_0040code_007bgetpwent_007d-user_002ddefined-function-1728"></a>
<pre class="example">     <!-- file eg/lib/passwdawk.in -->
     function getpwent()
     {
         _pw_init()
         if (_pw_count &lt; _pw_total)
             return _pw_bycount[++_pw_count]
         return ""
     }
     <!-- endfile -->
</pre>
   <p><a name="index-g_t_0040code_007bendpwent_007d-function-_0028C-library_0029-1729"></a>The <code>endpwent<!-- /@w --></code> function resets <code>_pw_count<!-- /@w --></code> to zero, so that
subsequent calls to <code>getpwent</code> start over again:

   <p><a name="index-g_t_0040code_007bendpwent_007d-user_002ddefined-function-1730"></a>
<pre class="example">     <!-- file eg/lib/passwdawk.in -->
     function endpwent()
     {
         _pw_count = 0
     }
     <!-- endfile -->
</pre>
   <p>A conscious design decision in this suite was made that each subroutine calls
<code>_pw_init<!-- /@w --></code> to initialize the database arrays.  The overhead of running
a separate process to generate the user database, and the I/O to scan it,
are only incurred if the user's main program actually calls one of these
functions.  If this library file is loaded along with a user's program, but
none of the routines are ever called, then there is no extra runtime overhead. 
(The alternative is move the body of <code>_pw_init<!-- /@w --></code> into a
<code>BEGIN</code> rule, which always runs <samp><span class="command">pwcat</span></samp>.  This simplifies the
code but runs an extra process that may never be needed.)

   <p>In turn, calling <code>_pw_init</code> is not too expensive, because the
<code>_pw_inited</code> variable keeps the program from reading the data more than
once.  If you are worried about squeezing every last cycle out of your
<samp><span class="command">awk</span></samp> program, the check of <code>_pw_inited</code> could be moved out of
<code>_pw_init</code> and duplicated in all the other functions.  In practice,
this is not necessary, since most <samp><span class="command">awk</span></samp> programs are I/O-bound, and it
clutters up the code.

   <p>The <samp><span class="command">id</span></samp> program in <a href="Id-Program.html#Id-Program">Id Program</a>,
uses these functions. 
<!-- ENDOFRANGE libfudata -->
<!-- ENDOFRANGE flibudata -->
<!-- ENDOFRANGE udatar -->
<!-- ENDOFRANGE dataur -->

   <div class="footnote">
<hr>
<h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> It is often the case that password
information is stored in a network database.</p>

   <hr></div>

   </body></html>

