<html lang="en">
<head>
<title>Extract Program - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Miscellaneous-Programs.html#Miscellaneous-Programs" title="Miscellaneous Programs">
<link rel="prev" href="History-Sorting.html#History-Sorting" title="History Sorting">
<link rel="next" href="Simple-Sed.html#Simple-Sed" title="Simple Sed">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Extract-Program"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Simple-Sed.html#Simple-Sed">Simple Sed</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="History-Sorting.html#History-Sorting">History Sorting</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Miscellaneous-Programs.html#Miscellaneous-Programs">Miscellaneous Programs</a>
<hr>
</div>

<h4 class="subsection">13.3.7 Extracting Programs from Texinfo Source Files</h4>

<!-- STARTOFRANGE texse -->
<p><a name="index-Texinfo_002c-extracting-programs-from-source-files-1823"></a><!-- STARTOFRANGE fitex -->
<a name="index-files_002c-Texinfo_0040comma_007b_007d-extracting-programs-from-1824"></a>Both this chapter and the previous chapter
(<a href="Library-Functions.html#Library-Functions">Library Functions</a>)
present a large number of <samp><span class="command">awk</span></samp> programs. 
If you want to experiment with these programs, it is tedious to have to type
them in by hand.  Here we present a program that can extract parts of a
Texinfo input file into separate files.

   <p><a name="index-Texinfo-1825"></a>This Web page is written in Texinfo, the GNU project's document
formatting
language. 
A single Texinfo source file can be used to produce both
printed and online documentation. 
Texinfo is fully documented in the book
<cite>Texinfo&mdash;The GNU Documentation Format</cite>,
available from the Free Software Foundation.

   <p>For our purposes, it is enough to know three things about Texinfo input
files:

     <ul>
<li>The &ldquo;at&rdquo; symbol (&lsquo;<samp><span class="samp">@</span></samp>&rsquo;) is special in Texinfo, much as
the backslash (&lsquo;<samp><span class="samp">\</span></samp>&rsquo;) is in C
or <samp><span class="command">awk</span></samp>.  Literal &lsquo;<samp><span class="samp">@</span></samp>&rsquo; symbols are represented in Texinfo source
files as &lsquo;<samp><span class="samp">@@</span></samp>&rsquo;.

     <li>Comments start with either &lsquo;<samp><span class="samp">@c</span></samp>&rsquo; or &lsquo;<samp><span class="samp">@comment</span></samp>&rsquo;. 
The file-extraction program works by using special comments that start
at the beginning of a line.

     <li>Lines containing &lsquo;<samp><span class="samp">@group</span></samp>&rsquo; and &lsquo;<samp><span class="samp">@end group</span></samp>&rsquo; commands bracket
example text that should not be split across a page boundary. 
(Unfortunately, TeX isn't always smart enough to do things exactly right,
and we have to give it some help.) 
</ul>

   <p>The following program, <samp><span class="file">extract.awk</span></samp>, reads through a Texinfo source
file and does two things, based on the special comments. 
Upon seeing &lsquo;<samp><span class="samp">@c&nbsp;system&nbsp;...<!-- /@w --></span></samp>&rsquo;,
it runs a command, by extracting the command text from the
control line and passing it on to the <code>system</code> function
(see <a href="I_002fO-Functions.html#I_002fO-Functions">I/O Functions</a>). 
Upon seeing &lsquo;<samp><span class="samp">@c file </span><var>filename</var></samp>&rsquo;, each subsequent line is sent to
the file <var>filename</var>, until &lsquo;<samp><span class="samp">@c endfile</span></samp>&rsquo; is encountered. 
The rules in <samp><span class="file">extract.awk</span></samp> match either &lsquo;<samp><span class="samp">@c</span></samp>&rsquo; or
&lsquo;<samp><span class="samp">@comment</span></samp>&rsquo; by letting the &lsquo;<samp><span class="samp">omment</span></samp>&rsquo; part be optional. 
Lines containing &lsquo;<samp><span class="samp">@group</span></samp>&rsquo; and &lsquo;<samp><span class="samp">@end group</span></samp>&rsquo; are simply removed. 
<samp><span class="file">extract.awk</span></samp> uses the <code>join</code> library function
(see <a href="Join-Function.html#Join-Function">Join Function</a>).

   <p>The example programs in the online Texinfo source for <cite>GAWK: Effective AWK Programming</cite>
(<samp><span class="file">gawk.texi</span></samp>) have all been bracketed inside &lsquo;<samp><span class="samp">file</span></samp>&rsquo; and
&lsquo;<samp><span class="samp">endfile</span></samp>&rsquo; lines.  The <samp><span class="command">gawk</span></samp> distribution uses a copy of
<samp><span class="file">extract.awk</span></samp> to extract the sample programs and install many
of them in a standard directory where <samp><span class="command">gawk</span></samp> can find them. 
The Texinfo file looks something like this:

<pre class="example">     ...
     This program has a @code{BEGIN} rule,
     that prints a nice message:
     
     @example
     @c file examples/messages.awk
     BEGIN @{ print "Don't panic!" @}
     @c end file
     @end example
     
     It also prints some final advice:
     
     @example
     @c file examples/messages.awk
     END @{ print "Always avoid bored archeologists!" @}
     @c end file
     @end example
     ...
</pre>
   <p><samp><span class="file">extract.awk</span></samp> begins by setting <code>IGNORECASE</code> to one, so that
mixed upper- and lowercase letters in the directives won't matter.

   <p>The first rule handles calling <code>system</code>, checking that a command is
given (<code>NF</code> is at least three) and also checking that the command
exits with a zero exit status, signifying OK:

   <p><a name="index-g_t_0040code_007bextract_002eawk_007d-program-1826"></a>
<pre class="example">     <!-- file eg/prog/extract.awk -->
     # extract.awk --- extract files and run programs
     #                 from texinfo files
     <!-- endfile -->
     <!-- file eg/prog/extract.awk -->
     BEGIN    { IGNORECASE = 1 }
     
     /^@c(omment)?[ \t]+system/    \
     {
         if (NF &lt; 3) {
             e = (FILENAME ":" FNR)
             e = (e  ": badly formed `system' line")
             print e &gt; "/dev/stderr"
             next
         }
         $1 = ""
         $2 = ""
         stat = system($0)
         if (stat != 0) {
             e = (FILENAME ":" FNR)
             e = (e ": warning: system returned " stat)
             print e &gt; "/dev/stderr"
         }
     }
     <!-- endfile -->
</pre>
   <p class="noindent">The variable <code>e</code> is used so that the function
fits nicely on the
page. 
screen.

   <p>The second rule handles moving data into files.  It verifies that a
file name is given in the directive.  If the file named is not the
current file, then the current file is closed.  Keeping the current file
open until a new file is encountered allows the use of the &lsquo;<samp><span class="samp">&gt;</span></samp>&rsquo;
redirection for printing the contents, keeping open file management
simple.

   <p>The &lsquo;<samp><span class="samp">for</span></samp>&rsquo; loop does the work.  It reads lines using <code>getline</code>
(see <a href="Getline.html#Getline">Getline</a>). 
For an unexpected end of file, it calls the <code>unexpected_eof<!-- /@w --></code>
function.  If the line is an &ldquo;endfile&rdquo; line, then it breaks out of
the loop. 
If the line is an &lsquo;<samp><span class="samp">@group</span></samp>&rsquo; or &lsquo;<samp><span class="samp">@end group</span></samp>&rsquo; line, then it
ignores it and goes on to the next line. 
Similarly, comments within examples are also ignored.

   <p>Most of the work is in the following few lines.  If the line has no &lsquo;<samp><span class="samp">@</span></samp>&rsquo;
symbols, the program can print it directly. 
Otherwise, each leading &lsquo;<samp><span class="samp">@</span></samp>&rsquo; must be stripped off. 
To remove the &lsquo;<samp><span class="samp">@</span></samp>&rsquo; symbols, the line is split into separate elements of
the array <code>a</code>, using the <code>split</code> function
(see <a href="String-Functions.html#String-Functions">String Functions</a>). 
The &lsquo;<samp><span class="samp">@</span></samp>&rsquo; symbol is used as the separator character. 
Each element of <code>a</code> that is empty indicates two successive &lsquo;<samp><span class="samp">@</span></samp>&rsquo;
symbols in the original line.  For each two empty elements (&lsquo;<samp><span class="samp">@@</span></samp>&rsquo; in
the original file), we have to add a single &lsquo;<samp><span class="samp">@</span></samp>&rsquo; symbol back in.

   <p>When the processing of the array is finished, <code>join</code> is called with the
value of <code>SUBSEP</code>, to rejoin the pieces back into a single
line.  That line is then printed to the output file:

<pre class="example">     <!-- file eg/prog/extract.awk -->
     /^@c(omment)?[ \t]+file/    \
     {
         if (NF != 3) {
             e = (FILENAME ":" FNR ": badly formed `file' line")
             print e &gt; "/dev/stderr"
             next
         }
         if ($3 != curfile) {
             if (curfile != "")
                 close(curfile)
             curfile = $3
         }
     
         for (;;) {
             if ((getline line) &lt;= 0)
                 unexpected_eof()
             if (line ~ /^@c(omment)?[ \t]+endfile/)
                 break
             else if (line ~ /^@(end[ \t]+)?group/)
                 continue
             else if (line ~ /^@c(omment+)?[ \t]+/)
                 continue
             if (index(line, "@") == 0) {
                 print line &gt; curfile
                 continue
             }
             n = split(line, a, "@")
             # if a[1] == "", means leading @,
             # don't add one back in.
             for (i = 2; i &lt;= n; i++) {
                 if (a[i] == "") { # was an @@
                     a[i] = "@"
                     if (a[i+1] == "")
                         i++
                 }
             }
             print join(a, 1, n, SUBSEP) &gt; curfile
         }
     }
     <!-- endfile -->
</pre>
   <p>An important thing to note is the use of the &lsquo;<samp><span class="samp">&gt;</span></samp>&rsquo; redirection. 
Output done with &lsquo;<samp><span class="samp">&gt;</span></samp>&rsquo; only opens the file once; it stays open and
subsequent output is appended to the file
(see <a href="Redirection.html#Redirection">Redirection</a>). 
This makes it easy to mix program text and explanatory prose for the same
sample source file (as has been done here!) without any hassle.  The file is
only closed when a new data file name is encountered or at the end of the
input file.

   <p>Finally, the function <code>unexpected_eof<!-- /@w --></code> prints an appropriate
error message and then exits. 
The <code>END</code> rule handles the final cleanup, closing the open file:

<!-- function lb put on same line for page breaking. sigh -->
<pre class="example">     <!-- file eg/prog/extract.awk -->
     function unexpected_eof() {
         printf("%s:%d: unexpected EOF or error\n",
             FILENAME, FNR) &gt; "/dev/stderr"
         exit 1
     }
     
     END {
         if (curfile)
             close(curfile)
     }
     <!-- endfile -->
</pre>
   <!-- ENDOFRANGE texse -->
<!-- ENDOFRANGE fitex -->
   </body></html>

