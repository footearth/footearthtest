<html lang="en">
<head>
<title>Close Files And Pipes - The GNU Awk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="The GNU Awk User's Guide">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Printing.html#Printing" title="Printing">
<link rel="prev" href="Special-Files.html#Special-Files" title="Special Files">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1989, 1991, 1992, 1993, 1996, 1997, 1998, 1999,
2000, 2001, 2002, 2003, 2004, 2005, 2007, 2009 Free Software Foundation, Inc.



   This is Edition 3 of `GAWK: Effective AWK Programming: A User's Guide for GNU Awk',
for the 3.1.7 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``GNU General Public License'', the Front-Cover
texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.
  a. ``A GNU Manual''

  b. ``You have the freedom to copy and modify this GNU manual.  Buying
     copies from the FSF supports it in developing GNU and promoting
     software freedom.''
        -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="Close-Files-And-Pipes"></a>
<p>
Previous:&nbsp;<a rel="previous" accesskey="p" href="Special-Files.html#Special-Files">Special Files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Printing.html#Printing">Printing</a>
<hr>
</div>

<h3 class="section">4.8 Closing Input and Output Redirections</h3>

<p><a name="index-files_002c-output_002c-See-output-files-593"></a><!-- STARTOFRANGE ifc -->
<a name="index-input-files_002c-closing-594"></a><!-- STARTOFRANGE ofc -->
<a name="index-output_002c-files_0040comma_007b_007d-closing-595"></a><!-- STARTOFRANGE pc -->
<a name="index-pipes_002c-closing-596"></a><!-- STARTOFRANGE cc -->
<a name="index-coprocesses_002c-closing-597"></a><a name="index-g_t_0040code_007bgetline_007d-command_002c-coprocesses_0040comma_007b_007d-using-from-598"></a>
If the same file name or the same shell command is used with <code>getline</code>
more than once during the execution of an <samp><span class="command">awk</span></samp> program
(see <a href="Getline.html#Getline">Getline</a>),
the file is opened (or the command is executed) the first time only. 
At that time, the first record of input is read from that file or command. 
The next time the same file or command is used with <code>getline</code>,
another record is read from it, and so on.

   <p>Similarly, when a file or pipe is opened for output, the file name or
command associated with it is remembered by <samp><span class="command">awk</span></samp>, and subsequent
writes to the same file or command are appended to the previous writes. 
The file or pipe stays open until <samp><span class="command">awk</span></samp> exits.

   <p><a name="index-g_t_0040code_007bclose_007d-function-599"></a>This implies that special steps are necessary in order to read the same
file again from the beginning, or to rerun a shell command (rather than
reading more output from the same command).  The <code>close</code> function
makes these things possible:

<pre class="example">     close(<var>filename</var>)
</pre>
   <p class="noindent">or:

<pre class="example">     close(<var>command</var>)
</pre>
   <p>The argument <var>filename</var> or <var>command</var> can be any expression.  Its
value must <em>exactly</em> match the string that was used to open the file or
start the command (spaces and other &ldquo;irrelevant&rdquo; characters
included). For example, if you open a pipe with this:

<pre class="example">     "sort -r names" | getline foo
</pre>
   <p class="noindent">then you must close it with this:

<pre class="example">     close("sort -r names")
</pre>
   <p>Once this function call is executed, the next <code>getline</code> from that
file or command, or the next <code>print</code> or <code>printf</code> to that
file or command, reopens the file or reruns the command. 
Because the expression that you use to close a file or pipeline must
exactly match the expression used to open the file or run the command,
it is good practice to use a variable to store the file name or command. 
The previous example becomes the following:

<pre class="example">     sortcom = "sort -r names"
     sortcom | getline foo
     ...
     close(sortcom)
</pre>
   <p class="noindent">This helps avoid hard-to-find typographical errors in your <samp><span class="command">awk</span></samp>
programs.  Here are some of the reasons for closing an output file:

     <ul>
<li>To write a file and read it back later on in the same <samp><span class="command">awk</span></samp>
program.  Close the file after writing it, then
begin reading it with <code>getline</code>.

     <li>To write numerous files, successively, in the same <samp><span class="command">awk</span></samp>
program.  If the files aren't closed, eventually <samp><span class="command">awk</span></samp> may exceed a
system limit on the number of open files in one process.  It is best to
close each one when the program has finished writing it.

     <li>To make a command finish.  When output is redirected through a pipe,
the command reading the pipe normally continues to try to read input
as long as the pipe is open.  Often this means the command cannot
really do its work until the pipe is closed.  For example, if
output is redirected to the <samp><span class="command">mail</span></samp> program, the message is not
actually sent until the pipe is closed.

     <li>To run the same program a second time, with the same arguments. 
This is not the same thing as giving more input to the first run!

     <p>For example, suppose a program pipes output to the <samp><span class="command">mail</span></samp> program. 
If it outputs several lines redirected to this pipe without closing
it, they make a single message of several lines.  By contrast, if the
program closes the pipe after each line of output, then each line makes
a separate message. 
</ul>

   <p><a name="index-differences-in-_0040command_007bawk_007d-and-_0040command_007bgawk_007d_002c-_0040code_007bclose_007d-function-600"></a><a name="index-portability_002c-_0040code_007bclose_007d-function-and-601"></a>If you use more files than the system allows you to have open,
<samp><span class="command">gawk</span></samp> attempts to multiplex the available open files among
your data files.  <samp><span class="command">gawk</span></samp>'s ability to do this depends upon the
facilities of your operating system, so it may not always work.  It is
therefore both good practice and good portability advice to always
use <code>close</code> on your files when you are done with them. 
In fact, if you are using a lot of pipes, it is essential that
you close commands when done. For example, consider something like this:

<pre class="example">     {
         ...
         command = ("grep " $1 " /some/file | my_prog -q " $3)
         while ((command | getline) &gt; 0) {
             <var>process output of</var> command
         }
         # need close(command) here
     }
</pre>
   <p>This example creates a new pipeline based on data in <em>each</em> record. 
Without the call to <code>close</code> indicated in the comment, <samp><span class="command">awk</span></samp>
creates child processes to run the commands, until it eventually
runs out of file descriptors for more pipelines.

   <p>Even though each command has finished (as indicated by the end-of-file
return status from <code>getline</code>), the child process is not
terminated;<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>
<!-- Good old UNIX: give the marketing guys fits, that's the ticket -->
more importantly, the file descriptor for the pipe
is not closed and released until <code>close</code> is called or
<samp><span class="command">awk</span></samp> exits.

   <p><code>close</code> will silently do nothing if given an argument that
does not represent a file, pipe or coprocess that was opened with
a redirection.

   <p>Note also that &lsquo;<samp><span class="samp">close(FILENAME)</span></samp>&rsquo; has no
&ldquo;magic&rdquo; effects on the implicit loop that reads through the
files named on the command line.  It is, more likely, a close
of a file that was never opened, so <samp><span class="command">awk</span></samp> silently
does nothing.

   <p><a name="index-g_t_0040code_007b_007c_007d-_0028vertical-bar_0029_002c-_0040code_007b_007c_0026_007d-operator-_0028I_002fO_0029_002c-pipes_0040comma_007b_007d-closing-602"></a>When using the &lsquo;<samp><span class="samp">|&amp;</span></samp>&rsquo; operator to communicate with a coprocess,
it is occasionally useful to be able to close one end of the two-way
pipe without closing the other. 
This is done by supplying a second argument to <code>close</code>. 
As in any other call to <code>close</code>,
the first argument is the name of the command or special file used
to start the coprocess. 
The second argument should be a string, with either of the values
<code>"to"</code> or <code>"from"</code>.  Case does not matter. 
As this is an advanced feature, a more complete discussion is
delayed until
<a href="Two_002dway-I_002fO.html#Two_002dway-I_002fO">Two-way I/O</a>,
which discusses it in more detail and gives an example.

<!-- fakenode - for prepinfo -->
<h4 class="subheading">Advanced Notes: Using <code>close</code>'s Return Value</h4>

<p><a name="index-advanced-features_002c-_0040code_007bclose_007d-function-603"></a><a name="index-dark-corner_002c-_0040code_007bclose_007d-function-604"></a><a name="index-g_t_0040code_007bclose_007d-function_002c-return-values-605"></a><a name="index-return-values_0040comma_007b_007d-_0040code_007bclose_007d-function-606"></a><a name="index-differences-in-_0040command_007bawk_007d-and-_0040command_007bgawk_007d_002c-_0040code_007bclose_007d-function-607"></a><a name="index-Unix-_0040command_007bawk_007d_002c-_0040code_007bclose_007d-function-and-608"></a>
In many versions of Unix <samp><span class="command">awk</span></samp>, the <code>close</code> function
is actually a statement.  It is a syntax error to try and use the return
value from <code>close</code>:
(d.c.)

<pre class="example">     command = "..."
     command | getline info
     retval = close(command)  # syntax error in most Unix awks
</pre>
   <p><samp><span class="command">gawk</span></samp> treats <code>close</code> as a function. 
The return value is &minus;1 if the argument names something
that was never opened with a redirection, or if there is
a system problem closing the file or process. 
In these cases, <samp><span class="command">gawk</span></samp> sets the built-in variable
<code>ERRNO</code> to a string describing the problem.

   <p>In <samp><span class="command">gawk</span></samp>,
when closing a pipe or coprocess (input or output),
the return value is the exit status of the command.<a rel="footnote" href="#fn-2" name="fnd-2"><sup>2</sup></a>
Otherwise, it is the return value from the system's <code>close</code> or
<code>fclose</code> C functions when closing input or output
files, respectively. 
This value is zero if the close succeeds, or &minus;1 if
it fails.

   <p>The POSIX standard is very vague; it says that <code>close</code>
returns zero on success and non-zero otherwise.  In general,
different implementations vary in what they report when closing
pipes; thus the return value cannot be used portably. 
(d.c.)

<!-- ENDOFRANGE ifc -->
<!-- ENDOFRANGE ofc -->
<!-- ENDOFRANGE pc -->
<!-- ENDOFRANGE cc -->
<!-- ENDOFRANGE prnt -->
   <div class="footnote">
<hr>
<h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> The technical terminology is rather morbid. 
The finished child is called a &ldquo;zombie,&rdquo; and cleaning up after
it is referred to as &ldquo;reaping.&rdquo;</p>

   <p class="footnote"><small>[<a name="fn-2" href="#fnd-2">2</a>]</small> 
This is a full 16-bit value as returned by the <code>wait</code>
system call. See the system manual pages for information on
how to decode this value.</p>

   <hr></div>

   </body></html>

