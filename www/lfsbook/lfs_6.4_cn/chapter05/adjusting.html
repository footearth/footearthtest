<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      5.8.&nbsp;调整工具链
    </title>
    <link rel="stylesheet" href="../stylesheets/lfs.css" type="text/css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.73.2" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="lfs" id="lfs-6.4">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 6.4
      </h4>
      <h3>
        第&nbsp;5&nbsp;章&nbsp;构建临时系统
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="glibc.html" title=
          "Glibc-2.8-20080929">上一页</a>
          <p>
            Glibc-2.8-20080929
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="tcl.html" title="Tcl-8.5.5">下一页</a>
          <p>
            Tcl-8.5.5
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 6.4">起始页</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-adjusting" name="ch-tools-adjusting"></a>5.8. 调整工具链
      </h1>
      <p>
        现在，安装好了 C
        语言的临时库，本章中剩余章节所有要编译的工具都要链接到这些库文件上。为此，需要调整连接器和编译器的工程设计（specs）文件。
      </p>
      <p>
        在第一遍编译 Binutils
        结束时已经调整过的连接器，现在需要被重新命名以便可以被正确的找到和使用。首先备份原来的连接器，然后用调整过的连接器来替代，最后还要创建一个指向
        <code class="filename">/tools/$(gcc -dumpmachine)/bin</code>
        中连接器副本的连接。
      </p>
      <pre class="userinput">
<kbd class="command">mv -v /tools/bin/{ld,ld-old}
mv -v /tools/$(gcc -dumpmachine)/bin/{ld,ld-old}
mv -v /tools/bin/{ld-new,ld}
ln -sv /tools/bin/ld /tools/$(gcc -dumpmachine)/bin/ld</kbd>
</pre>
      <p>
        从现在开始，所有的程序都将链接到 <code class="filename">/tools/lib</code> 目录下的库文件。
      </p>
      <p>
        下面的任务是修改 GCC 的“<span class="quote">specs</span>”文件，使 GCC
        可以默认指向新的动态链接器。一个简单的 <span class="command"><strong>sed</strong></span>
        代换就可以做到：
      </p>
      <p>
        为了准备起见，推荐使用复制粘贴的办法来应用下面的命令。请亲眼确认下 specs 文件，保证每一处“<span class=
        "quote">/lib/ld-linux.so.2</span>”都被替换成了“<span class=
        "quote">/tools/lib/ld-linux.so.2</span>”：
      </p>
      <div class="admon important">
        <img alt="[重要]" src="../images/important.png" />
        <h3>
          重要
        </h3>
        <p>
          如果你的系统平台上的动态链接器名字不是 <code class=
          "filename">ld-linux.so.2</code>，请将下面命令中的“<span class=
          "quote">ld-linux.so.2</span>”替换为相应的动态链接器名称。如果需要，请参阅<a class="xref"
          href="toolchaintechnotes.html" title=
          "5.2.&nbsp;工具链技术说明">第&nbsp;5.2&nbsp;节 “工具链技术说明”</a>。
        </p>
      </div>
      <pre class="userinput">
<kbd class=
"command">gcc -dumpspecs | sed 's@/lib/ld-linux.so.2@/tools&amp;@g' \
  &gt; `dirname $(gcc -print-libgcc-file-name)`/specs</kbd>
</pre>
      <p>
        在编译过程中，GCC 会运行 fixincludes
        脚本来扫描系统头文件目录，并找出需要修正的头文件（比如包含语法错误），然后把修正后的文件放到 GCC
        专属头文件目录里。因此，它可能会找出宿主系统中需要修正的头文件，并将修正后的结果放到 GCC
        专属头文件目录里。由于本章的剩余部分仅需要使用当前已经安装好的 GCC 和 Glibc 的头文件，所以任何“<span class=
        "quote">修正后的</span>”头文件都可以被安全的删除。并且这样做也有助于避免宿主系统中的头文件污染编译环境。运行下面的命令删除
        GCC 专属头文件目录中的头文件(由于命令较长，推荐你拷贝和粘贴命令，而不是手动输入)：
      </p>
      <pre class="userinput">
<kbd class=
"command">GCC_FIXED=`dirname $(gcc -print-libgcc-file-name)`/include-fixed &amp;&amp;
find ${GCC_FIXED}/* -maxdepth 0 -xtype d -exec rm -rvf '{}' \; &amp;&amp;
rm -vf `grep -l "DO NOT EDIT THIS FILE" ${GCC_FIXED}/*` &amp;&amp;
unset GCC_FIXED</kbd>
</pre>
      <div class="admon caution">
        <img alt="[小心]" src="../images/caution.png" />
        <h3>
          小心
        </h3>
        <p>
          现在，有必要停下来检查新工具链能够完成预期功能（编译和链接），运行下面命令完成合理的检查：
        </p>
        <pre class="userinput">
<kbd class="command">echo 'main(){}' &gt; dummy.c
cc dummy.c
readelf -l a.out | grep ': /tools'</kbd>
</pre>
        <p>
          如果工作一切正常，应该不会出错，最后一个命令的输出应该是：
        </p>
        <pre class="screen">
<code class="computeroutput">[Requesting program interpreter:
    /tools/lib/ld-linux.so.2]</code>
</pre>
        <p>
          注意，<code class="filename">/tools/lib</code> 应该是动态链接器的前缀。
        </p>
        <p>
          如果输出和上面的不一样，或者根本没有输出，就一定是出错了。返回前面的步骤查找问题所在，在纠正这个问题之前不要继续往下做。首先，重新做上一个检查，但用
          <span class="command"><strong>gcc</strong></span> 替换 <span class=
          "command"><strong>cc</strong></span>，如果这次输出正确了，说明链接到 <span class=
          "command"><strong>cc</strong></span> 的符号链接有问题，返回<a class="xref"
          href="gcc-pass1.html" title=
          "5.5.&nbsp;GCC-4.3.2 - 第一遍">第&nbsp;5.5&nbsp;节 “GCC-4.3.2 -
          第一遍”</a>创建符号链接。下一步，确保 <code class="envar">PATH</code> 变量的正确，这可以通过运行
          <span class="command"><strong>echo $PATH</strong></span>，验证
          <code class="filename">/tools/bin</code>是否在输出列表的最开头。如果 <code class=
          "envar">PATH</code> 变量出错，可能是因为你不是作为 <code class=
          "systemitem">lfs</code> 用户登入，也可能是在做<a class="xref" href=
          "../chapter04/settingenvironment.html" title=
          "4.4.&nbsp;设置编译环境">第&nbsp;4.4&nbsp;节 “设置编译环境”</a>时出错了。另外一个原因可能是上面修正
          specs 文件时出错，如果这样，重新修改 specs 文件，复制粘贴时要小心仔细。
        </p>
        <p>
          一切正常之后，清理测试文件：
        </p>
        <pre class="userinput">
<kbd class="command">rm -v dummy.c a.out</kbd>
</pre>
      </div>
      <div class="admon note">
        <img alt="[注意]" src="../images/note.png" />
        <h3>
          注意
        </h3>
        <p>
          下一节编译 Tcl 时为了验证工具链构建正确而做的附加检验工具。如果 Tcl 编译失败，错误出在 Binutils、GCC、或者
          Glibc 的安装，而不是 Tcl 本身。
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="glibc.html" title=
          "Glibc-2.8-20080929">上一页</a>
          <p>
            Glibc-2.8-20080929
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="tcl.html" title="Tcl-8.5.5">下一页</a>
          <p>
            Tcl-8.5.5
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 6.4">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
